{% extends 'base.html' %}

{% block content %}

<!-- Page content-->
<div class="container mt-5">
    <div class="row">
        <div class="col-lg-8">
            <!-- Post content-->
            <article>
                <!-- Post header-->
                <header class="mb-4">
                    <!-- Post title-->
                    <h1 class="fw-bolder mb-1">{{ single_blog.title }}</h1>
                    <!-- Post meta content-->
                    <div class="text-muted fst-italic mb-2">{{ single_blog.created_at | timesince}} ago | BY {{
                        single_blog.author }}</div>
                    <!-- Post category-->
                    <a class="badge bg-warning text-decoration-none text-light"
                        href="{% url 'posts_by_category' single_blog.category.id %}">{{ single_blog.category }}</a>
                </header>
                <!-- Preview image figure-->
                <figure class="mb-4"><img class="img-fluid rounded" src="{{ single_blog.featured_image.url }}"
                        alt="..." /></figure>
                <!-- Post content-->
                <section class="mb-5">
                    <p class="fs-5 mb-4">{{ single_blog.short_description }}</p>
                    <p class="fs-5 mb-4">{{ single_blog.blog_body }}</p>


                    <!-- comment section -->
                    <br><br>
                    <div class="form-group">

                        {% if user.is_authenticated %}
                        <h4 class="mb-4">Leave a Comment</h4>
                        <form action="" method="POST" id="commentForm">
                            {% csrf_token %}
                            <div class="form-group">
                                <textarea class="form-control" name="comment" placeholder="Write your comment here..."
                                    required></textarea>
                            </div>
                            <input type="submit" value="Submit Comment" class="btn btn-primary mt-2">
                        </form>

                        <script>
                            document.getElementById('commentForm').addEventListener('submit', function (e) {
                                e.preventDefault();  // stop page reload

                                const formData = new FormData(this);

                                fetch("", {
                                    method: "POST",
                                    body: formData,
                                    headers: {
                                        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
                                    }
                                }).then(response => location.reload()); // or update DOM dynamically
                            });
                        </script>

                        {% else %}
                        <p>Please <a href="{% url 'login' %}">login</a> to leave a comment.</p>
                        {% endif %}
                    </div>



                    <div class="mt-5">
                        <h4 class="mb-4">Comments ({{ comment_count }})</h4>
                        {% for comment in comments %}
                        {% if not comment.parent %}
                        <div class="card mb-3" id="comment-{{ comment.id }}">
                            <div class="card-body">
                                <small class="text-muted">
                                    <strong>{{ comment.user }} Â· {{ comment.created_at|timesince }} ago</strong>
                                </small>

<!-- for edit and delete comment in main comment only -->


<a href=""><i class="fa fa-edit text-success"></i></a>
                    &nbsp;
{% if request.user == comment.user %}
<button type="button"
        class="btn btn-link text-danger p-0 ms-2"
        onclick="deleteComment({{ comment.id }})">
    <i class="fa fa-trash text-danger"></i>
</button>
{% endif %}



                                <p class="card-text">{{ comment.comment }}</p>

                                <!-- Reply button -->
                                <button type="button" class="btn btn-link p-0"
                                    onclick="toggleReplyForm('{{ comment.id }}')">
                                    Reply
                                </button>




                                <!-- Reply form -->
                                <form method="POST" class="reply-form mt-2 d-none" id="reply-form-{{ comment.id }}">

                                    {% csrf_token %}
                                    <input type="hidden" name="parent_id" value="{{ comment.id }}">

                                    <textarea name="comment" class="form-control mb-2" rows="2"
                                        placeholder="Write a reply..." required></textarea>

                                    <button type="submit" class="btn btn-sm btn-primary">Reply</button>
                                </form>


                                <!-- ðŸ” RECURSION HAPPENS HERE -->
                                {% for reply in comment.replies.all %}
                                {% include 'blogs/comment.html' with comment=reply level=level|add:1 %}
                                {% endfor %}



                            </div>
                        </div>
                        {% endif %}
                        {% empty %}
                        <p>No comments yet.</p>
                        {% endfor %}


                        <br>
                       
                    </div>
                </section>
            </article>
            
        </div>
        <!-- Side widgets-->
        <div class="col-lg-4">
            <!-- Categories widget-->
            <div class="card mb-4 p-3">
                <h4 class="font-italic">Categories</h4>
                <div class="card-body">
                    <div class="row">

                        <div class="col-sm-6">
                            <ul class="list-unstyled mb-0">
                                {% for cate in categories %}
                                <li><a href="{% url 'posts_by_category' cate.id %}">{{ cate.category_name }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Side widget-->
            {% if social_links %}
            <div class="p-3">
                <h4 class="font-italic">Follow Us</h4>
                <ol class="list-unstyled">
                    {% for social_link in social_links %}
                    <li><a href="{{ social_link.link }}" target="_blank">{{ social_link.platform }}</a></li>
                    {% endfor %}
                </ol>
            </div>
            {% endif %}
        </div>
    </div>
</div>


 <!-- Replace your JS with THIS (ONLY ONE SCRIPT, bottom of blogs.html) so that no reload (comment no reload, reply on that comment no reload but reply on that reply take reload) Now no reload now -->
                        <script>
                            function toggleReplyForm(id) {
                                const form = document.getElementById(`reply-form-${id}`);
                                if (form) {
                                    form.classList.toggle('d-none');
                                }
                            }

                            document.addEventListener('submit', function (e) {
                                const form = e.target;

                                // ðŸ”‘ This catches ALL reply forms (including nested replies)
                                if (form.querySelector('input[name="parent_id"]')) {
                                    e.preventDefault(); // STOP page reload

                                    const formData = new FormData(form);

                                    fetch("", {
                                        method: "POST",
                                        body: formData,
                                        headers: {
                                            "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
                                        }
                                    })
                                        .then(res => {
                                            if (res.ok) {
                                                location.reload(); // TEMP: confirms everything works
                                            }
                                        });
                                }
                            });
                        </script>
<script>
function deleteComment(commentId) {
    if (!confirm("Delete this comment?")) return;

    fetch("{% url 'delete_comment' 0 %}".replace("0", commentId), {
        method: "POST",
        headers: {
            "X-CSRFToken": getCSRFToken(),
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`comment-${commentId}`).remove();
        } else {
            alert(data.error || "Delete failed");
        }
    });
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}
</script>



{% endblock %}